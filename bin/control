#!/bin/bash

LOGFILE="${OPENSHIFT_TMP_DIR}/seafile.log"

function start() {
  echo "Running start" >> $LOGFILE
  if [ ! -f ${OPENSHIFT_DATA_DIR}/installed ]; then
    mkdir ${OPENSHIFT_REPO_DIR}/conf
    rm -rf ${OPENSHIFT_DATA_DIR}/seafile
    export PYTHON="python"
    python $OPENSHIFT_REPO_DIR/seafile-server-3.0.3/setup-seafile-mysql.py
    sed "/SERVICE_URL/s|^\(.* = \).*$|\1http://${OPENSHIFT_GEAR_DNS}:${OPENSHIFT_DIY_PORT}|" \
      $OPENSHIFT_REPO_DIR/ccnet/ccnet.conf
    touch ${OPENSHIFT_DATA_DIR}/installed
  fi
  
  $OPENSHIFT_REPO_DIR/seafile-server-latest/seafile.sh start
  $OPENSHIFT_REPO_DIR/seafile-server-latest/seahub.sh start 8080
  
  echo "Ran start" >> $LOGFILE
}

function stop() {
  echo "Running stop" >> $LOGFILE
  $OPENSHIFT_REPO_DIR/seafile-server-latest/seafile.sh stop
  $OPENSHIFT_REPO_DIR/seafile-server-latest/seahub.sh stop
  echo "Ran stop" >> $LOGFILE
}

date >> $LOGFILE
echo "Running control" >> $LOGFILE

case $1 in
  start) start;;
  stop) stop;;
  restart) start; stop;;
esac
